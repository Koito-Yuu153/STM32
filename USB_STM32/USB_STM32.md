# 一、USB介绍

## 1、USB的背景简介

- USB ，是英文 Universal Serial BUS（通用串行总线）的缩写，而其中文简称为“通串线， 是一个外部总线标准，用于规范电脑与外部设备的连接和通讯。是应用在 PC 领域的接口技术。
- USB 接口支持设备的即插即用和热插拔功能。USB 是在 1994 年底由英特尔、康柏、IBM、 Microsoft 等多家公司联合提出的。
- USB 发展到现在已经有 USB1.0/1.1/2.0/3.0 等多个版本。目前用的最多的就是 USB1.1 和 USB2.0，USB3.0 目前已经开始普及。

## 2、USB的几种概念

- USB Host： Host端控制整个总线的数据传输的。单个USB总线上，只能有一个Host
- USB Slave:  也就是USB的设备端
- USB OTG:    On The Go，这是在USB2.0引入的一种mode，提出了一个新的概念叫主机协商协议（Host Negotiation Protocol），允许两个设备间商量谁去当Host

**只有当一台Host设备与一台Slave设备相链接的时候，才能实现数据传输。**

**OTG举例：**当OTG插到电脑上时， OTG的角色就是连接电脑的device，也就是Slave；当USB device 插到OTG上的时候，，OTG的角色就是Host。

## 3、USB的插入检测

> **STM32F1自带有USB OTG FS，像STM32F4自带有USB OTG FS (全速)和 USB OTG HS(高速)，其中HS要外扩高速PHY芯片实现。**

标准 USB 共四根线组成 , 除 VCC/GND 外，另外为 D+和 D-，这两根数据线采用的是差分电压的方式进行数据传输的。

**USB Host判断设备端是何种速度设备的判别方法：**

**在 USB 主机上，D-和 D+都是接了15K 的电阻到地的，所以在没 有设备接入的时候，D+、D-均是低电平。**
**低速设备：会在D-（DM）上接一个1.5K 的电阻到VCC**
**全速设备：会在D+（DP）上接一个1.5K 的电阻到VCC**
**高速设备：会在D+（DP）上接一个1.5K 的电阻到VCC，主机对设备进行复位后进一步进行确认**



## USB版本更迭

![](img\USB版本更迭.jpg)

USB从1.0~2.0为止一直在提升速度，1.0是Low Speed，1.1是Full Speed，目前大部分的键盘鼠标都跑在Full Speed，因为速度已经非常够用了。2.0是High Speed。

到了3.0速度一下子就提升到了5Gb/s并且加了一个8b/10b编码，这是因为速度太高了，要避免电磁干扰（EMI）。所以3.0的实际有效带宽最高是4Gb。

3.1相对于3.0做了一个较大的提升，速率提升到了10Gb/s，并且将3.0并入到3.1Gen1中。3.1Gen2则是相对于3.0的提升版本，将频率提高到了10Gb/s，且采用128b/132b编码，有效带宽相对于3.0（3.1Gen1）提升了约2.5倍。此时USB组织官方希望市面上不要在出现3.0的字样，统一用3.1代替（因为3.0实际上就是3.1Gen1），但当时市面上的命名还是相当混乱的。

TypeC1.0推出，相对于传统的USB多出了几个Pin脚

3.2推出，3.2Gen1x1实际上就是3.0，3.2Gen2x1对应3.1Gen2，3.2Gen2x2则是一个新东西，Gen2x2虽然频率与编码与3.1Gen2（3.2Gen2x1）相同，但它把TypeC多出的PIn脚拿出来用，所以它有两个通道，有效带宽翻倍。

TypeC2.0推出

USB4.0推出后我们可以看到，它没有3.1Gen1和3.2Gen1x1一样与3.0兼容的版本，也没有3.2Gen2x1这种与3.1兼容的版本。尽管4.0Gen2x2的频率与前几个版本一样是10Gb/s，但它采用的是完全不一样的编码。（与之前某一版本相同的话命名中总会带“1”，如3.1Gen1、3.2Gen2X1）。

我们把实际相同的版本并在一起，3.0其实包含在3.1中，3.1又包含在3.2中，3.2与3.4相互独立，得到下图：

![](img\USB版本更迭2.png)



## USB接口

usb公口

<img src="img\USB3.0接口.jpg" style="zoom:50%;" />

usb母口

<img src="img\USB3.0接口.png" style="zoom:50%;" />

| Contact   Number | Signal  Name |
| ---------------- | ------------ |
| 1                | VBUS         |
| 2                | D-           |
| 3                | D+           |
| 4                | GND          |

USB装置可以自己带电，也可以由主机（Host）供电，大部分都是由Host供电的。1和4引脚比2、3引脚长，这样插入usb设备时就会先进行供电。

USB接口是蓝色的说明它至少支持3.0版本，能跑Super Speed；如果是蓝色和黑色就只支持到2.0，跑High Speed。

USB公口的1~4脚是平面形式，母口的1~4做成弹片去贴合，见上图。

USB公口的5~9脚是弹片形式，母口的5~9做成平面去贴合，见上图。

<img src="img\传输测试.png" style="zoom: 50%;" />

将一个U盘插入电脑，如果只插入一半，1~4脚贴合，5~9脚没贴合，那么传输只能跑在USB2.0的High Speed上，图中为36.3MB/秒。如果完全插入，所有引脚全部贴合，那么就能跑在USB3.0或者以上的Super Speed上，图中为172MB/秒，差距还是非常大的。这里是用的网图，我有个USB3.0的U盘但是浸过水，现在只能跑在2.0的速度下QAQ

![](img\USB电缆.png)

上图是USB3.1的缆线图（cable--电缆，缆线），1~4脚的D+/-引脚与5~9脚的RX+/-、TX+/-是不会同时使用的，跑2.0及之前的版本只用D，跑3.0及其兼容版本只用R/T。

3.1之后出现的TypeC的接线更多了，有D+/-、TX1+/-、RX1+/-、TX2+/-、RX2+/-。现在不讲TypeC，略过就好。



## USB的拓扑结构

<img src="img\USB拓扑结构.jpg" style="zoom: 150%;" />

从上图我们可以得出如下信息：

- 在一个USB通讯网络中只存在一个Root Hub，Root Hub和主机结合，电脑上每个USB接口都是一个Root Hub，它们之间是相互独立的，可以扩展连接出多个相互独立的USB网络。
- 网络深度最多为7层，2~6这5层可以接Hub（集线器），第7层只能接设备，不能接Hub。
- 在USB网络中，只存在两种基本形式，Hub（集线器）用来扩展接口，相当于信息的中转站、交通枢纽；一种是设备（Function），是真正的真正的通讯目标，例如键盘鼠标和U盘。
- 在USB网络中还有一种特别的设备，叫复合设备（Compound Device），它实际上是一个Hub，但这个Hub它有一个自己内建的设备，当你把这个Hub插入到网络中，它里面的设备就会被检测到，但它并不是分开的两个产品。
